<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>LiveScript - Home</title>
        <style>
            .container {
                display: flex;
                height: 100vh;
            }
            .file-list {
                width: 20%;
                height: 100%;
                overflow-y: auto;
                background: #f4f4f4;
                padding: 10px;
                border-right: 1px solid #ccc;
                position: relative;
            }
            .file-list-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 5px;
                border-bottom: 1px solid #ddd;
                margin-bottom: 10px;
            }
            .add-file-btn {
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                font-weight: bold;
            }
            .file-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                border-bottom: 1px solid #ddd;
                cursor: pointer;
                position: relative;
            }
            .file-item:hover {
                background-color: #e0e0e0;
            }
            .file-item.active {
                background-color: #d0d0d0;
            }
            .file-name {
                display: flex;
                align-items: center;
            }
            .file-extension {
                color: #666;
                margin-left: 5px;
                font-size: 0.8em;
            }
            .menu-button {
                background: none;
                border: none;
                font-size: 20px;
                cursor: pointer;
            }
            .menu-dropdown {
                display: none;
                position: absolute;
                right: 10px;
                background: white;
                border: 1px solid #ccc;
                box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
                list-style: none;
                padding: 5px;
                width: 120px;
                z-index: 100;
            }
            .menu-dropdown li {
                padding: 5px;
                cursor: pointer;
            }
            .menu-dropdown li:hover {
                background: #f4f4f4;
            }
            .modal, .modal-overlay {
                display: none;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 5px;
                box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
                z-index: 1000;
            }
            .modal-overlay {
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }
            .modal-buttons {
                margin-top: 15px;
                display: flex;
                justify-content: space-between;
            }
            .file-type-select {
                margin-top: 10px;
                width: 100%;
                padding: 5px;
            }
            .content {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            .header {
                padding: 10px 20px;
                background: #f0f0f0;
                border-bottom: 1px solid #ccc;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .header h1 {
                margin: 0;
                font-size: 1.5em;
            }
            .file-display {
                flex: 1;
                padding: 20px;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            #file-content {
                width: 100%;
                height: 100%;
                resize: none;
                border: 1px solid #ccc;
                padding: 10px;
                font-size: 16px;
                font-family: monospace;
                background: #f9f9f9;
                box-sizing: border-box;
            }
            .file-info {
                margin-bottom: 10px;
                font-family: monospace;
                color: #666;
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 5px;
            }
            .save-btn {
                padding: 5px 15px;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
            }
            .save-btn:hover {
                background-color: #45a049;
            }
            .save-btn:disabled {
                background-color: #cccccc;
                cursor: not-allowed;
            }
            .save-btn, .share-btn {
                margin-right: 0;
            }
            
            /* Cursor Indicator Styles */
            .remote-cursor {
                position: absolute;
                border-left: 2px solid;
                height: 1.2em;
                opacity: 0.7;
            }

            .remote-cursor-label {
                position: absolute;
                top: -1.4em;
                left: 0;
                font-size: 10px;
                font-weight: bold;
                padding: 1px 3px;
                border-radius: 2px;
                white-space: nowrap;
                color: white;
            }

            .remote-selection {
                position: absolute;
                opacity: 0.2;
            }

            .user-color-0 { background-color: #F44336; border-color: #F44336; }
            .user-color-1 { background-color: #2196F3; border-color: #2196F3; }
            .user-color-2 { background-color: #4CAF50; border-color: #4CAF50; }
            .user-color-3 { background-color: #FF9800; border-color: #FF9800; }
            .user-color-4 { background-color: #9C27B0; border-color: #9C27B0; }
            .user-color-5 { background-color: #00BCD4; border-color: #00BCD4; }
            .user-color-6 { background-color: #FFEB3B; border-color: #FFEB3B; }
            .user-color-7 { background-color: #795548; border-color: #795548; }

            .collaborator-info {
                display: flex;
                align-items: center;
                margin-right: 10px;
            }

            .collaborator-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                margin-right: 5px;
            }

            .collaborators-list {
                display: flex;
                margin-right: 10px;
                align-items: center;
            }
            
            #collaborators-modal {
                min-width: 250px;
            }

            #collaborators-list li {
                padding: 8px 10px;
                display: flex;
                align-items: center;
                border-bottom: 1px solid #eee;
            }

            #collaborators-list li:last-child {
                border-bottom: none;
            }

            .collaborator-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                display: inline-block;
                margin-right: 8px;
            }
        </style>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/codemirror.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/addon/lint/lint.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/codemirror.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/mode/javascript/javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/mode/python/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/mode/css/css.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/mode/htmlmixed/htmlmixed.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/addon/lint/lint.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.0/jshint.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/addon/lint/javascript-lint.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify.min.js"></script>
    </head>
    <body>
        <div class="container">
            <div class="file-list">
                <div class="file-list-header">
                    <h3>Files</h3>
                    <button class="add-file-btn" onclick="openCreateFileModal()">+</button>
                </div>
                <ul id="file-list">
                    <h4>Your Files</h4>
                    {% for file in files %}
                        <li class="file-item" data-file-id="{{ file.id }}" data-file-type="{{ file.file_type }}" onclick="loadFileContent('{{ file.id }}', this)">
                            <span class="file-name">
                                <span class="file-name-text">{{ file.name }}</span>
                                <span class="file-extension">.{{ file.file_type }}</span>
                            </span>
                            <button class="menu-button" onclick="toggleMenu(event)">⋮</button>
                            <ul class="menu-dropdown">
                                <li onclick="openRenameModal('{{ file.id }}', '{{ file.name }}')">Rename</li>
                                <li onclick="openDeleteModal('{{ file.id }}', '{{ file.name }}')">Delete</li>
                            </ul>
                        </li>
                    {% empty %}
                        <p>No files found.</p>
                    {% endfor %}
                    <h4>Collaborative Files</h4>
                    {% for file in collaborative_files %}
                        <li class="file-item" data-file-id="{{ file.id }}" data-file-type="{{ file.file_type }}" onclick="loadFileContent('{{ file.id }}', this)">
                            <span class="file-name">
                                <span class="file-name-text">{{ file.name }}</span>
                                <span class="file-extension">.{{ file.file_type }}</span>
                            </span>
                        </li>
                    {% empty %}
                        <p>No collaborative files found.</p>
                    {% endfor %}
                </ul>
            </div>
            <div class="content">
                <div class="header">
                    <h1>Welcome, {{ username }}!</h1>
                    <form action="{% url 'logout' %}" method="post">
                        {% csrf_token %}
                        <button type="submit">Logout</button>
                    </form>
                </div>
                <div class="file-display">
                    <div class="file-info">
                        <span id="file-info">No file selected</span>
                        <div class="collaborators-list" id="collaborators-list"></div>
                        <button id="save-btn" class="save-btn" onclick="saveFileContent()" disabled>Save</button>
                        <button id="share-btn" class="save-btn share-btn" onclick="openShareModal()">Share</button>
                        <button id="run-btn" class="save-btn" onclick="runCode()" disabled>Run</button>
                        <span id="collaborators-count" class="collaborators-count" onclick="showCollaborators()">0</span>
                    </div>
                    <textarea id="file-content" placeholder="No file open"></textarea>
                </div>
            </div>
        </div>

        <!-- Create File Modal -->
        <div class="modal-overlay" id="modal-overlay" onclick="closeModals()"></div>
        <div class="modal" id="create-file-modal">
            <h3>Create New File</h3>
            <input type="text" id="create-file-input" placeholder="File name">
            <select id="file-type-select" class="file-type-select">
                <option value="py">Python (.py)</option>
                <option value="js">JavaScript (.js)</option>
                <option value="css">CSS (.css)</option>
                <option value="html">HTML (.html)</option>
            </select>
            <div class="modal-buttons">
                <button onclick="closeModals()">Cancel</button>
                <button onclick="createFile()">Create</button>
            </div>
        </div>

        <!-- Rename Modal -->
        <div class="modal" id="rename-modal">
            <h3>Rename File</h3>
            <input type="text" id="rename-input">
            <div class="modal-buttons">
                <button onclick="closeModals()">Cancel</button>
                <button onclick="renameFile()">Rename</button>
            </div>
        </div>

        <!-- Delete Modal -->
        <div class="modal" id="delete-modal">
            <h3>Delete File</h3>
            <p>Type <strong>"<span id="expected-filename"></span>"</strong> to confirm deletion:</p>
            <input type="text" id="delete-confirm" placeholder="Enter filename here">
            <div class="modal-buttons">
                <button onclick="closeModals()">Cancel</button>
                <button onclick="deleteFile()">Delete</button>
            </div>
        </div>

        <!-- Share Modal -->
        <div class="modal-overlay" id="share-modal-overlay" onclick="closeModals()"></div>
        <div class="modal" id="share-modal">
            <h3>Share File</h3>
            <p>Copy the link below to share this file:</p>
            <input type="text" id="share-link" readonly>
            <button onclick="copyShareLink()">Copy</button>
            <div class="modal-buttons">
                <button onclick="closeModals()">Close</button>
            </div>
        </div>

        <!-- Collaborators Modal -->
        <div class="modal-overlay" id="collaborators-modal-overlay" onclick="closeModals()"></div>
        <div class="modal" id="collaborators-modal">
            <h3>Collaborators</h3>
            <ul id="collaborators-list"></ul>
            <div class="modal-buttons">
                <button onclick="closeModals()">Close</button>
            </div>
        </div>

        <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
        <script>
            // Update the Socket.IO URL to match the correct server address
            const socket = io("https://livescript-rza9.onrender.com");
            let currentFileId = null;
            let currentFileElement = null;
            let editor = null;
            const remoteCursors = {};
            const remoteSelections = {};
            const userColors = {};
            let nextColorIndex = 0;

            document.addEventListener("DOMContentLoaded", function () {
                let isRemoteUpdate = false;
                let textChangeTimeout = null;
                let autoSaveTimeout = null;
                let isTyping = false;

                editor = CodeMirror.fromTextArea(document.getElementById("file-content"), {
                    mode: "javascript",
                    lineNumbers: true,
                    lint: true,
                    gutters: ["CodeMirror-lint-markers"],
                });
                editor.on("scroll", updateAllRemoteCursors);
                editor.on("update", updateAllRemoteCursors);
                editor.on("viewportChange", updateAllRemoteCursors);

                // Also call updateAllRemoteCursors after setting content
                editor.on("change", function() {
                    // Wait a bit for the editor to update layout
                    setTimeout(updateAllRemoteCursors, 50);
                });

                editor.on("change", function (instance, changeObj) {
                    if (isRemoteUpdate) {
                        isRemoteUpdate = false;
                        return;
                    }

                    isTyping = true;
                    document.getElementById("save-btn").disabled = false;

                    clearTimeout(textChangeTimeout);
                    textChangeTimeout = setTimeout(() => {
                        if (currentFileId) {
                            const content = instance.getValue();
                            const cursor = instance.getCursor();
                            socket.emit("textChange", { fileId: currentFileId, content, cursor });
                        }
                    }, 300);

                    clearTimeout(autoSaveTimeout);
                    autoSaveTimeout = setTimeout(() => {
                        if (isTyping && currentFileId) {
                            saveFileContent();
                            isTyping = false;
                        }
                    }, 5000);
                });

                // Add cursor activity event to track local cursor movements
                editor.on("cursorActivity", function() {
                    if (currentFileId && !isRemoteUpdate) {
                        const cursor = editor.getCursor();
                        socket.emit("cursorActivity", { 
                            fileId: currentFileId, 
                            cursor, 
                            username: "{{ username }}" 
                        });
                    }
                });

                socket.on("textChange", ({ content, cursor, username }) => {
                    if (currentFileId) {
                        isRemoteUpdate = true;
                        
                        // Save current cursor position
                        const currentCursor = editor.getCursor();
                        
                        // Update text content
                        editor.setValue(content);
                        
                        // Restore local cursor
                        editor.setCursor(currentCursor);
                        
                        // Update remote cursor position
                        if (username) {
                            updateRemoteCursor(username, cursor);
                        }
                        
                        isRemoteUpdate = false;
                    }
                });

                // Socket event to update cursor positions when users join
                socket.on("updateCursorPositions", (positions) => {
                    Object.keys(positions).forEach(username => {
                        if (username !== "{{ username }}") {
                            updateRemoteCursor(username, positions[username]);
                        }
                    });
                });

                // Socket event to update a specific user's cursor
                socket.on("updateCursor", ({ username, cursor }) => {
                    updateRemoteCursor(username, cursor);
                });

                // Socket event to remove cursor when a user leaves
                socket.on("removeCursor", (username) => {
                    removeRemoteCursor(username);
                });

                document.addEventListener("keydown", function (event) {
                    if (event.ctrlKey && event.key === "s") {
                        event.preventDefault();
                        if (currentFileId) {
                            saveFileContent();
                        }
                    }
                });
            });

            function joinFileRoom(fileId, username) {
                socket.emit("joinFile", { fileId, username });
            }

            function leaveFileRoom(fileId, username) {
                socket.emit("leaveFile", { fileId, username });
            }

            function showCollaborators() {
                document.getElementById("collaborators-modal").style.display = "block";
                document.getElementById("collaborators-modal-overlay").style.display = "block";
            }

            socket.on("updateCollaborators", (collaborators) => {
                const collaboratorsCount = document.getElementById("collaborators-count");
                const collaboratorsList = document.getElementById("collaborators-list");

                collaboratorsCount.textContent = collaborators.length;

                // Clear remote cursors for users who are no longer collaborating
                Object.keys(remoteCursors).forEach(username => {
                    if (!collaborators.includes(username)) {
                        removeRemoteCursor(username);
                    }
                });
                
                // Update the full collaborators modal
                const fullCollaboratorsList = document.getElementById("collaborators-list");
                if (fullCollaboratorsList) {
                    fullCollaboratorsList.innerHTML = "";
                    collaborators.forEach((collaborator) => {
                        const li = document.createElement("li");
                        
                        // Add color indicator
                        const colorDot = document.createElement('span');
                        colorDot.className = `collaborator-dot ${getUserColor(collaborator)}`;
                        colorDot.style.display = 'inline-block';
                        colorDot.style.marginRight = '5px';
                        
                        li.appendChild(colorDot);
                        li.appendChild(document.createTextNode(collaborator));
                        fullCollaboratorsList.appendChild(li);
                    });
                }
            });

            // Function to get a consistent color for each user
            function getUserColor(username) {
                if (!userColors[username]) {
                    userColors[username] = nextColorIndex % 8;
                    nextColorIndex++;
                }
                return `user-color-${userColors[username]}`;
            }

            // Function to update a remote cursor
            
function updateRemoteCursor(username, cursor) {
    // Skip if it's the current user
    if (username === "{{ username }}") return;
    
    // Remove old cursor if it exists
    removeRemoteCursor(username);
    
    // Use CodeMirror's marker API for more reliable positioning
    const cursorPos = {line: cursor.line, ch: cursor.ch};
    const cursorCoords = editor.cursorCoords(cursorPos, "local");
    
    const cursorElement = document.createElement('div');
    cursorElement.className = `remote-cursor ${getUserColor(username)}`;
    // Increase the left position offset to fix the issue
    cursorElement.style.left = `${cursorCoords.left + 45}px`;
    cursorElement.style.top = `${cursorCoords.top}px`;
    cursorElement.style.height = `${editor.defaultTextHeight()}px`;
    
    // Create label showing username
    const labelElement = document.createElement('div');
    labelElement.className = `remote-cursor-label ${getUserColor(username)}`;
    labelElement.textContent = username;
    cursorElement.appendChild(labelElement);
    
    // Add to DOM
    editor.getWrapperElement().appendChild(cursorElement);
    
    // Store the cursor element and position for later updates
    remoteCursors[username] = {
        element: cursorElement,
        position: cursor
    };
    
    // Update collaborators list in header
    updateCollaboratorsList();
}

// Add a function to update all remote cursor positions
function updateAllRemoteCursors() {
    Object.keys(remoteCursors).forEach(username => {
        const cursorData = remoteCursors[username];
        if (cursorData && cursorData.position) {
            const cursorPos = {line: cursorData.position.line, ch: cursorData.position.ch};
            const cursorCoords = editor.cursorCoords(cursorPos, "local");
            
            cursorData.element.style.left = `${cursorCoords.left}px`;
            cursorData.element.style.top = `${cursorCoords.top}px`;
            cursorData.element.style.height = `${editor.defaultTextHeight()}px`;
        }
    });
}

// Update removeRemoteCursor function
function removeRemoteCursor(username) {
    if (remoteCursors[username]) {
        if (remoteCursors[username].element) {
            remoteCursors[username].element.remove();
        }
        delete remoteCursors[username];
    }
    
    if (remoteSelections[username]) {
        remoteSelections[username].forEach(marker => marker.clear());
        delete remoteSelections[username];
    }
    
    // Update collaborators list
    updateCollaboratorsList();
}

            // Function to update the collaborators list in the header
            function updateCollaboratorsList() {
                const collaboratorsList = document.getElementById("collaborators-list") || createCollaboratorsList();
                collaboratorsList.innerHTML = '';
                
                Object.keys(remoteCursors).forEach(username => {
                    const collaboratorInfo = document.createElement('div');
                    collaboratorInfo.className = 'collaborator-info';
                    
                    const colorDot = document.createElement('div');
                    colorDot.className = `collaborator-dot ${getUserColor(username)}`;
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = username;
                    
                    collaboratorInfo.appendChild(colorDot);
                    collaboratorInfo.appendChild(nameSpan);
                    collaboratorsList.appendChild(collaboratorInfo);
                });
            }

            // Function to create the collaborators list container if it doesn't exist
            function createCollaboratorsList() {
                const fileInfo = document.querySelector('.file-info');
                
                const collaboratorsListContainer = document.createElement('div');
                collaboratorsListContainer.className = 'collaborators-list';
                collaboratorsListContainer.id = 'collaborators-list';
                
                // Insert before the collaborators-count element
                const collaboratorsCount = document.getElementById('collaborators-count');
                fileInfo.insertBefore(collaboratorsListContainer, collaboratorsCount);
                
                return collaboratorsListContainer;
            }

            function loadFileContent(fileId, element) {
                // Clear all remote cursors when switching files
                Object.keys(remoteCursors).forEach(username => {
                    removeRemoteCursor(username);
                });

                if (currentFileId === fileId) {
                    editor.setValue("");
                    document.getElementById("file-info").textContent = "No file selected";
                    document.getElementById("save-btn").disabled = true;

                    element.classList.remove("active");

                    const username = "{{ username }}";
                    leaveFileRoom(fileId, username);

                    currentFileId = null;
                    currentFileElement = null;
                    return;
                }

                if (currentFileElement) {
                    currentFileElement.classList.remove("active");
                }

                element.classList.add("active");
                currentFileElement = element;
                currentFileId = fileId;

                const fileName = element.querySelector(".file-name-text").textContent;
                const fileExtension = element.querySelector(".file-extension").textContent;
                const fileType = element.getAttribute("data-file-type").toLowerCase().trim();

                document.getElementById("file-info").textContent = fileName + fileExtension;

                document.getElementById("save-btn").disabled = false;

                // Enable or disable the Run button based on file type
                const runBtn = document.getElementById("run-btn");
                if (fileType === "py" || fileType === "python") {
                    runBtn.disabled = false;
                } else {
                    runBtn.disabled = true;
                }

                const modeMap = {
                    python: "python",
                    js: "javascript",
                    css: "css",
                    html: "htmlmixed",
                    py: "python",
                };
                const mode = modeMap[fileType] || "javascript";
                editor.setOption("mode", mode);

                fetch(`/main/get_file_content/${fileId}/`, {
                    method: "GET",
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        editor.setValue(data.content);
                    } else {
                        editor.setValue("Error loading file: " + (data.error || "Unknown error"));
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    editor.setValue("Error loading file");
                });

                const username = "{{ username }}";
                joinFileRoom(fileId, username);
            }

            function saveFileContent() {
                if (!currentFileId) {
                    alert("No file selected");
                    return;
                }

                const currentCursor = editor.getCursor();

                const content = editor.getValue();
                const formattedContent = js_beautify(content);
                editor.setValue(formattedContent);
                editor.setCursor(currentCursor);

                const saveBtn = document.getElementById('save-btn');
                saveBtn.disabled = true;
                saveBtn.textContent = "Saving...";

                fetch(`/main/save_content/${currentFileId}/`, {
                    method: "POST",
                    body: new URLSearchParams({ content: formattedContent }),
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        saveBtn.textContent = "Saved!";
                        setTimeout(() => {
                            saveBtn.textContent = "Save";
                            saveBtn.disabled = false;
                        }, 1500);
                    } else {
                        saveBtn.textContent = "Save";
                        saveBtn.disabled = false;
                        alert(data.error || "Failed to save file");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    saveBtn.textContent = "Save";
                    saveBtn.disabled = false;
                    alert("An error occurred while saving the file");
                });
            }

            function shareFile() {
                alert("Share functionality is not implemented yet.");
            }

            function reloadFileContent(fileId) {
                fetch(`/main/get_file_content/${fileId}/`, {
                    method: "GET",
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        editor.setValue(data.content);
                    }
                })
                .catch(error => {
                    console.error("Error reloading content:", error);
                });
            }

            function openCreateFileModal() {
                document.getElementById("create-file-input").value = "";
                document.getElementById("create-file-modal").style.display = "block";
                document.getElementById("modal-overlay").style.display = "block";
            }

            function createFile() {
                let fileName = document.getElementById("create-file-input").value;
                let fileType = document.getElementById("file-type-select").value;

                if (!fileName) {
                    alert("Please enter a file name");
                    return;
                }

                fetch('/main/create_file/', {
                    method: "POST",
                    body: new URLSearchParams({
                        name: fileName,
                        file_type: fileType
                    }),
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.id) {
                        const fileList = document.getElementById('file-list');

                        const noFiles = fileList.querySelector('p');
                        if (noFiles) {
                            fileList.innerHTML = '';
                        }

                        const li = document.createElement('li');
                        li.className = 'file-item';
                        li.setAttribute('data-file-id', data.id);
                        li.setAttribute('data-file-type', data.file_type);
                        li.setAttribute('onclick', `loadFileContent('${data.id}', this)`);

                        li.innerHTML = `
                            <span class="file-name">
                                <span class="file-name-text">${data.name}</span>
                                <span class="file-extension">.${data.file_type}</span>
                            </span>
                            <button class="menu-button" onclick="toggleMenu(event)">⋮</button>
                            <ul class="menu-dropdown">
                                <li onclick="openRenameModal('${data.id}', '${data.name}')">Rename</li>
                                <li onclick="openDeleteModal('${data.id}', '${data.name}')">Delete</li>
                            </ul>
                        `;

                        fileList.appendChild(li);
                        closeModals();

                        loadFileContent(data.id, li);
                    } else {
                        alert(data.error || "Failed to create file");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("An error occurred while creating the file");
                });
            }
            function openRenameModal(fileId, fileName) {
                event.stopPropagation();
                currentFileId = fileId;
                document.getElementById("rename-input").value = fileName;
                document.getElementById("rename-modal").style.display = "block";
                document.getElementById("modal-overlay").style.display = "block";
            }

            function renameFile() {
                let newName = document.getElementById("rename-input").value;

                if (!newName) {
                    alert("Please enter a new name");
                    return;
                }

                fetch(`/main/rename_file/${currentFileId}/`, {
                    method: "POST",
                    body: new URLSearchParams({ new_name: newName }),
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const fileItem = document.querySelector(`[data-file-id='${currentFileId}']`);
                        if (fileItem) {
                            fileItem.querySelector('.file-name-text').textContent = newName;

                            if (fileItem.classList.contains('active')) {
                                const fileExtension = fileItem.querySelector('.file-extension').textContent;
                                document.getElementById('file-info').textContent = newName + fileExtension;
                            }
                        }
                        closeModals();
                    } else {
                        alert(data.error || "Failed to rename file");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("An error occurred while renaming the file");
                });
            }

            function openDeleteModal(fileId, fileName) {
                event.stopPropagation();
                currentFileId = fileId;
                currentFileName = fileName;

                document.getElementById("expected-filename").textContent = fileName;

                document.getElementById("delete-confirm").value = "";

                document.getElementById("delete-modal").style.display = "block";
                document.getElementById("modal-overlay").style.display = "block";
            }

            function deleteFile() {
                let confirmInput = document.getElementById("delete-confirm").value;
                let expectedName = currentFileName;

                if (confirmInput !== expectedName) {
                    alert("File name doesn't match. Please enter exactly: " + expectedName);
                    return;
                }

                fetch(`/main/delete_file/${currentFileId}/`, {
                    method: "POST",
                    body: new URLSearchParams({ confirm_name: confirmInput }),
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const fileItem = document.querySelector(`[data-file-id='${currentFileId}']`);

                        if (fileItem && fileItem.classList.contains('active')) {
                            editor.setValue("");
                            document.getElementById('file-info').textContent = "No file selected";
                            document.getElementById('save-btn').disabled = true;
                            currentFileId = null;
                        }

                        if (fileItem) {
                            fileItem.remove();
                        }

                        const fileList = document.getElementById('file-list');
                        if (fileList.children.length === 0) {
                            fileList.innerHTML = '<p>No files found.</p>';
                        }

                        closeModals();
                    } else {
                        alert(data.error || "Failed to delete file");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("An error occurred while deleting the file");
                });
            }

            function closeModals() {
                document.querySelectorAll(".modal, .modal-overlay").forEach(el => {
                    el.style.display = "none";
                });
            }

            function openShareModal() {
                if (!currentFileId) {
                    alert("No file selected to share.");
                    return;
                }

                fetch(`/main/share_file/${currentFileId}/`, {
                    method: "GET",
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const shareLink = data.share_link;
                        document.getElementById("share-link").value = shareLink;
                        document.getElementById("share-modal").style.display = "block";
                        document.getElementById("share-modal-overlay").style.display = "block";
                    } else {
                        alert(data.error || "Failed to generate share link.");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("An error occurred while generating the share link.");
                });
            }

            function copyShareLink() {
                const shareLinkInput = document.getElementById("share-link");
                shareLinkInput.select();
                document.execCommand("copy");
                alert("Link copied to clipboard!");
            }

            function runCode() {
                if (!currentFileId) {
                    alert("No file selected to run.");
                    return;
                }

                fetch(`/main/run_code/${currentFileId}/`, {
                    method: "POST",
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Output:\n" + data.output);
                    } else {
                        alert("Error:\n" + (data.error || "Unknown error"));
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("An error occurred while running the code.");
                });
            }
        </script>
    </body>
</html>