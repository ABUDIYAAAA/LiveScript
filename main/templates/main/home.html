<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>LiveScript - Home</title>
        <style>
            .container {
                display: flex;
                height: 100vh;
            }
            .file-list {
                width: 20%;
                height: 100%;
                overflow-y: auto;
                background: #f4f4f4;
                padding: 10px;
                border-right: 1px solid #ccc;
                position: relative;
            }
            .file-list-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 5px;
                border-bottom: 1px solid #ddd;
                margin-bottom: 10px;
            }
            .add-file-btn {
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                font-weight: bold;
            }
            .file-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                border-bottom: 1px solid #ddd;
                cursor: pointer;
                position: relative;
            }
            .file-item:hover {
                background-color: #e0e0e0;
            }
            .file-item.active {
                background-color: #d0d0d0;
            }
            .file-name {
                display: flex;
                align-items: center;
            }
            .file-extension {
                color: #666;
                margin-left: 5px;
                font-size: 0.8em;
            }
            .menu-button {
                background: none;
                border: none;
                font-size: 20px;
                cursor: pointer;
            }
            .menu-dropdown {
                display: none;
                position: absolute;
                right: 10px;
                background: white;
                border: 1px solid #ccc;
                box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
                list-style: none;
                padding: 5px;
                width: 120px;
                z-index: 100;
            }
            .menu-dropdown li {
                padding: 5px;
                cursor: pointer;
            }
            .menu-dropdown li:hover {
                background: #f4f4f4;
            }
            .modal, .modal-overlay {
                display: none;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 5px;
                box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
                z-index: 1000;
            }
            .modal-overlay {
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }
            .modal-buttons {
                margin-top: 15px;
                display: flex;
                justify-content: space-between;
            }
            .file-type-select {
                margin-top: 10px;
                width: 100%;
                padding: 5px;
            }
            .content {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            .header {
                padding: 10px 20px;
                background: #f0f0f0;
                border-bottom: 1px solid #ccc;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .header h1 {
                margin: 0;
                font-size: 1.5em;
            }
            .file-display {
                flex: 1;
                padding: 20px;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            #file-content {
                width: 100%;
                height: 100%;
                resize: none;
                border: 1px solid #ccc;
                padding: 10px;
                font-size: 16px;
                font-family: monospace;
                background: #f9f9f9;
                box-sizing: border-box;
            }
            .file-info {
                margin-bottom: 10px;
                font-family: monospace;
                color: #666;
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 5px;
            }
            .save-btn {
                padding: 5px 15px;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
            }
            .save-btn:hover {
                background-color: #45a049;
            }
            .save-btn:disabled {
                background-color: #cccccc;
                cursor: not-allowed;
            }
            .save-btn, .share-btn {
                margin-right: 0;
            }
        </style>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/codemirror.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/addon/lint/lint.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/codemirror.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/mode/javascript/javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/mode/python/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/mode/css/css.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/mode/htmlmixed/htmlmixed.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/addon/lint/lint.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.0/jshint.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/addon/lint/javascript-lint.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify.min.js"></script>
    </head>
    <body>
        <div class="container">
            <div class="file-list">
                <div class="file-list-header">
                    <h3>Files</h3>
                    <button class="add-file-btn" onclick="openCreateFileModal()">+</button>
                </div>
                <ul id="file-list">
                    <h4>Your Files</h4>
                    {% for file in files %}
                        <li class="file-item" data-file-id="{{ file.id }}" data-file-type="{{ file.file_type }}" onclick="loadFileContent('{{ file.id }}', this)">
                            <span class="file-name">
                                <span class="file-name-text">{{ file.name }}</span>
                                <span class="file-extension">.{{ file.file_type }}</span>
                            </span>
                            <button class="menu-button" onclick="toggleMenu(event)">⋮</button>
                            <ul class="menu-dropdown">
                                <li onclick="openRenameModal('{{ file.id }}', '{{ file.name }}')">Rename</li>
                                <li onclick="openDeleteModal('{{ file.id }}', '{{ file.name }}')">Delete</li>
                            </ul>
                        </li>
                    {% empty %}
                        <p>No files found.</p>
                    {% endfor %}
                    <h4>Collaborative Files</h4>
                    {% for file in collaborative_files %}
                        <li class="file-item" data-file-id="{{ file.id }}" data-file-type="{{ file.file_type }}" onclick="loadFileContent('{{ file.id }}', this)">
                            <span class="file-name">
                                <span class="file-name-text">{{ file.name }}</span>
                                <span class="file-extension">.{{ file.file_type }}</span>
                            </span>
                        </li>
                    {% empty %}
                        <p>No collaborative files found.</p>
                    {% endfor %}
                </ul>
            </div>
            <div class="content">
                <div class="header">
                    <h1>Welcome, {{ username }}!</h1>
                    <form action="{% url 'logout' %}" method="post">
                        {% csrf_token %}
                        <button type="submit">Logout</button>
                    </form>
                </div>
                <div class="file-display">
                    <div class="file-info">
                        <span id="file-info">No file selected</span>
                        <button id="save-btn" class="save-btn" onclick="saveFileContent()" disabled>Save</button>
                        <button id="share-btn" class="save-btn share-btn" onclick="openShareModal()">Share</button>
                        <span id="collaborators-count" class="collaborators-count" onclick="showCollaborators()">0</span>
                    </div>
                    <textarea id="file-content" placeholder="No file open"></textarea>
                </div>
            </div>
        </div>

        <!-- Create File Modal -->
        <div class="modal-overlay" id="modal-overlay" onclick="closeModals()"></div>
        <div class="modal" id="create-file-modal">
            <h3>Create New File</h3>
            <input type="text" id="create-file-input" placeholder="File name">
            <select id="file-type-select" class="file-type-select">
                <option value="py">Python (.py)</option>
                <option value="js">JavaScript (.js)</option>
                <option value="css">CSS (.css)</option>
                <option value="html">HTML (.html)</option>
            </select>
            <div class="modal-buttons">
                <button onclick="closeModals()">Cancel</button>
                <button onclick="createFile()">Create</button>
            </div>
        </div>

        <!-- Rename Modal -->
        <div class="modal" id="rename-modal">
            <h3>Rename File</h3>
            <input type="text" id="rename-input">
            <div class="modal-buttons">
                <button onclick="closeModals()">Cancel</button>
                <button onclick="renameFile()">Rename</button>
            </div>
        </div>

        <!-- Delete Modal -->
        <div class="modal" id="delete-modal">
            <h3>Delete File</h3>
            <p>Type <strong>"<span id="expected-filename"></span>"</strong> to confirm deletion:</p>
            <input type="text" id="delete-confirm" placeholder="Enter filename here">
            <div class="modal-buttons">
                <button onclick="closeModals()">Cancel</button>
                <button onclick="deleteFile()">Delete</button>
            </div>
        </div>

        <!-- Share Modal -->
        <div class="modal-overlay" id="share-modal-overlay" onclick="closeModals()"></div>
        <div class="modal" id="share-modal">
            <h3>Share File</h3>
            <p>Copy the link below to share this file:</p>
            <input type="text" id="share-link" readonly>
            <button onclick="copyShareLink()">Copy</button>
            <div class="modal-buttons">
                <button onclick="closeModals()">Close</button>
            </div>
        </div>

        <!-- Collaborators Modal -->
        <div class="modal-overlay" id="collaborators-modal-overlay" onclick="closeModals()"></div>
        <div class="modal" id="collaborators-modal">
            <h3>Collaborators</h3>
            <ul id="collaborators-list"></ul>
            <div class="modal-buttons">
                <button onclick="closeModals()">Close</button>
            </div>
        </div>

        <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
        <script>
            const socket = io("http://localhost:3000");
            let currentFileId = null;
            let currentFileElement = null;
            let editor = null;

            document.addEventListener("DOMContentLoaded", function () {
                let isRemoteUpdate = false;
                let textChangeTimeout = null;
                let autoSaveTimeout = null;
                let isTyping = false;

                editor = CodeMirror.fromTextArea(document.getElementById("file-content"), {
                    mode: "javascript",
                    lineNumbers: true,
                    lint: true,
                    gutters: ["CodeMirror-lint-markers"],
                });

                editor.on("change", function (instance, changeObj) {
                    if (isRemoteUpdate) {
                        isRemoteUpdate = false;
                        return;
                    }

                    isTyping = true;
                    document.getElementById("save-btn").disabled = false;

                    clearTimeout(textChangeTimeout);
                    textChangeTimeout = setTimeout(() => {
                        if (currentFileId) {
                            const content = instance.getValue();
                            const cursor = instance.getCursor();
                            socket.emit("textChange", { fileId: currentFileId, content, cursor });
                        }
                    }, 300);

                    clearTimeout(autoSaveTimeout);
                    autoSaveTimeout = setTimeout(() => {
                        if (isTyping && currentFileId) {
                            saveFileContent();
                            isTyping = false;
                        }
                    }, 5000);
                });

                socket.on("textChange", ({ content, cursor }) => {
                    if (currentFileId) {
                        const currentCursor = editor.getCursor();
                        isRemoteUpdate = true;
                        editor.setValue(content);
                        editor.setCursor(cursor);
                    }
                });

                document.addEventListener("keydown", function (event) {
                    if (event.ctrlKey && event.key === "s") {
                        event.preventDefault();
                        if (currentFileId) {
                            saveFileContent();
                        }
                    }
                });
            });

            function joinFileRoom(fileId, username) {
                socket.emit("joinFile", { fileId, username });
            }

            function leaveFileRoom(fileId, username) {
                socket.emit("leaveFile", { fileId, username });
            }

            function showCollaborators() {
                document.getElementById("collaborators-modal").style.display = "block";
                document.getElementById("collaborators-modal-overlay").style.display = "block";
            }

            socket.on("updateCollaborators", (collaborators) => {
                const collaboratorsCount = document.getElementById("collaborators-count");
                const collaboratorsList = document.getElementById("collaborators-list");

                collaboratorsCount.textContent = collaborators.length;

                collaboratorsList.innerHTML = "";
                collaborators.forEach((collaborator) => {
                    const li = document.createElement("li");
                    li.textContent = collaborator;
                    collaboratorsList.appendChild(li);
                });
            });

            function loadFileContent(fileId, element) {
                if (currentFileId === fileId) {
                    editor.setValue("");
                    document.getElementById("file-info").textContent = "No file selected";
                    document.getElementById("save-btn").disabled = true;

                    element.classList.remove("active");

                    const username = "{{ username }}";
                    leaveFileRoom(fileId, username);

                    currentFileId = null;
                    currentFileElement = null;
                    return;
                }

                if (currentFileElement) {
                    currentFileElement.classList.remove("active");
                }

                element.classList.add("active");
                currentFileElement = element;
                currentFileId = fileId;

                const fileName = element.querySelector(".file-name-text").textContent;
                const fileExtension = element.querySelector(".file-extension").textContent;
                const fileType = element.getAttribute("data-file-type").toLowerCase().trim();

                document.getElementById("file-info").textContent = fileName + fileExtension;

                document.getElementById("save-btn").disabled = false;

                const modeMap = {
                    python: "python",
                    js: "javascript",
                    css: "css",
                    html: "htmlmixed",
                    py: "python",
                };
                const mode = modeMap[fileType] || "javascript";
                editor.setOption("mode", mode);

                fetch(`/main/get_file_content/${fileId}/`, {
                    method: "GET",
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        editor.setValue(data.content);
                    } else {
                        editor.setValue("Error loading file: " + (data.error || "Unknown error"));
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    editor.setValue("Error loading file");
                });

                const username = "{{ username }}";
                joinFileRoom(fileId, username);
            }

            function saveFileContent() {
                if (!currentFileId) {
                    alert("No file selected");
                    return;
                }

                const currentCursor = editor.getCursor();

                const content = editor.getValue();
                const formattedContent = js_beautify(content);
                editor.setValue(formattedContent);
                editor.setCursor(currentCursor);

                const saveBtn = document.getElementById('save-btn');
                saveBtn.disabled = true;
                saveBtn.textContent = "Saving...";

                fetch(`/main/save_content/${currentFileId}/`, {
                    method: "POST",
                    body: new URLSearchParams({ content: formattedContent }),
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        saveBtn.textContent = "Saved!";
                        setTimeout(() => {
                            saveBtn.textContent = "Save";
                            saveBtn.disabled = false;
                        }, 1500);
                    } else {
                        saveBtn.textContent = "Save";
                        saveBtn.disabled = false;
                        alert(data.error || "Failed to save file");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    saveBtn.textContent = "Save";
                    saveBtn.disabled = false;
                    alert("An error occurred while saving the file");
                });
            }

            function shareFile() {
                alert("Share functionality is not implemented yet.");
            }

            function reloadFileContent(fileId) {
                fetch(`/main/get_file_content/${fileId}/`, {
                    method: "GET",
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        editor.setValue(data.content);
                    }
                })
                .catch(error => {
                    console.error("Error reloading content:", error);
                });
            }

            function openCreateFileModal() {
                document.getElementById("create-file-input").value = "";
                document.getElementById("create-file-modal").style.display = "block";
                document.getElementById("modal-overlay").style.display = "block";
            }

            function createFile() {
                let fileName = document.getElementById("create-file-input").value;
                let fileType = document.getElementById("file-type-select").value;

                if (!fileName) {
                    alert("Please enter a file name");
                    return;
                }

                fetch('/main/create_file/', {
                    method: "POST",
                    body: new URLSearchParams({
                        name: fileName,
                        file_type: fileType
                    }),
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.id) {
                        const fileList = document.getElementById('file-list');

                        const noFiles = fileList.querySelector('p');
                        if (noFiles) {
                            fileList.innerHTML = '';
                        }

                        const li = document.createElement('li');
                        li.className = 'file-item';
                        li.setAttribute('data-file-id', data.id);
                        li.setAttribute('data-file-type', data.file_type);
                        li.setAttribute('onclick', `loadFileContent('${data.id}', this)`);

                        li.innerHTML = `
                            <span class="file-name">
                                <span class="file-name-text">${data.name}</span>
                                <span class="file-extension">.${data.file_type}</span>
                            </span>
                            <button class="menu-button" onclick="toggleMenu(event)">⋮</button>
                            <ul class="menu-dropdown">
                                <li onclick="openRenameModal('${data.id}', '${data.name}')">Rename</li>
                                <li onclick="openDeleteModal('${data.id}', '${data.name}')">Delete</li>
                            </ul>
                        `;

                        fileList.appendChild(li);
                        closeModals();

                        loadFileContent(data.id, li);
                    } else {
                        alert(data.error || "Failed to create file");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("An error occurred while creating the file");
                });
            }

            function openRenameModal(fileId, fileName) {
                event.stopPropagation();
                currentFileId = fileId;
                document.getElementById("rename-input").value = fileName;
                document.getElementById("rename-modal").style.display = "block";
                document.getElementById("modal-overlay").style.display = "block";
            }

            function renameFile() {
                let newName = document.getElementById("rename-input").value;

                if (!newName) {
                    alert("Please enter a new name");
                    return;
                }

                fetch(`/main/rename_file/${currentFileId}/`, {
                    method: "POST",
                    body: new URLSearchParams({ new_name: newName }),
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const fileItem = document.querySelector(`[data-file-id='${currentFileId}']`);
                        if (fileItem) {
                            fileItem.querySelector('.file-name-text').textContent = newName;

                            if (fileItem.classList.contains('active')) {
                                const fileExtension = fileItem.querySelector('.file-extension').textContent;
                                document.getElementById('file-info').textContent = newName + fileExtension;
                            }
                        }
                        closeModals();
                    } else {
                        alert(data.error || "Failed to rename file");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("An error occurred while renaming the file");
                });
            }

            function openDeleteModal(fileId, fileName) {
                event.stopPropagation();
                currentFileId = fileId;
                currentFileName = fileName;

                document.getElementById("expected-filename").textContent = fileName;

                document.getElementById("delete-confirm").value = "";

                document.getElementById("delete-modal").style.display = "block";
                document.getElementById("modal-overlay").style.display = "block";
            }

            function deleteFile() {
                let confirmInput = document.getElementById("delete-confirm").value;
                let expectedName = currentFileName;

                if (confirmInput !== expectedName) {
                    alert("File name doesn't match. Please enter exactly: " + expectedName);
                    return;
                }

                fetch(`/main/delete_file/${currentFileId}/`, {
                    method: "POST",
                    body: new URLSearchParams({ confirm_name: confirmInput }),
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const fileItem = document.querySelector(`[data-file-id='${currentFileId}']`);

                        if (fileItem && fileItem.classList.contains('active')) {
                            editor.setValue("");
                            document.getElementById('file-info').textContent = "No file selected";
                            document.getElementById('save-btn').disabled = true;
                            currentFileId = null;
                        }

                        if (fileItem) {
                            fileItem.remove();
                        }

                        const fileList = document.getElementById('file-list');
                        if (fileList.children.length === 0) {
                            fileList.innerHTML = '<p>No files found.</p>';
                        }

                        closeModals();
                    } else {
                        alert(data.error || "Failed to delete file");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("An error occurred while deleting the file");
                });
            }

            function closeModals() {
                document.querySelectorAll(".modal, .modal-overlay").forEach(el => {
                    el.style.display = "none";
                });
            }

            function openShareModal() {
                if (!currentFileId) {
                    alert("No file selected to share.");
                    return;
                }

                fetch(`/main/share_file/${currentFileId}/`, {
                    method: "GET",
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const shareLink = data.share_link;
                        document.getElementById("share-link").value = shareLink;
                        document.getElementById("share-modal").style.display = "block";
                        document.getElementById("share-modal-overlay").style.display = "block";
                    } else {
                        alert(data.error || "Failed to generate share link.");
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("An error occurred while generating the share link.");
                });
            }

            function copyShareLink() {
                const shareLinkInput = document.getElementById("share-link");
                shareLinkInput.select();
                document.execCommand("copy");
                alert("Link copied to clipboard!");
            }
        </script>
    </body>
</html>